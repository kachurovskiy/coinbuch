<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>coinbuch</title>
  <link rel="icon" href="data:,">
  <script type="module" crossorigin>
var R=Object.defineProperty;var q=(n,e,t)=>e in n?R(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var g=(n,e,t)=>(q(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const L=["Advanced Trade Buy","Receive"],w=["Advanced Trade Sell","Send"],S=w.concat(["Withdrawal"]),G=L.concat(["Deposit","Reward Income","Subscription Rebate","Subscription Rebates (24 Hours)"]),A=["Advanced Trade Buy","Advanced Trade Sell","Deposit","Receive","Reward Income","Send","Subscription Rebate","Subscription Rebates (24 Hours)","Withdrawal"],C=["AUD","CAD","CHF","CNY","EUR","GBP","HKD","JPY","KRW","NZD","SGD","USD"],P=new Map([["AUD","A$"],["CAD","C$"],["CHF","CHF"],["CNY","¥"],["EUR","€"],["GBP","£"],["HKD","$"],["JPY","¥"],["KRW","₩"],["NZD","NZ$"],["SGD","SGD"],["USD","$"]]),E=["USDC","USDT"],Y=1e-7;function H(n,e){return n.time.getFullYear()<2e3||n.time.getFullYear()>2100?`Invalid year ${n.time.getFullYear()} in row ${JSON.stringify(e)}`:A.includes(n.type)?isNaN(n.quantity)?`Invalid quantity ${n.quantity} in row ${JSON.stringify(e)}`:isNaN(n.price)||n.price<0?`Invalid price ${n.price} in row ${JSON.stringify(e)}`:isNaN(n.fee)||n.fee<0?`Invalid fee ${n.fee} in row ${JSON.stringify(e)}`:isNaN(n.subtotal)?`Invalid subtotal ${n.subtotal} in row ${JSON.stringify(e)}`:isNaN(n.total)?`Invalid total ${n.total} in row ${JSON.stringify(e)}`:"":`Invalid transaction type ${n.type} in row ${JSON.stringify(e)}`}function M(n,e){const t=n.subtotal+n.fee*(w.includes(n.type)?-1:1);if(t>0&&Math.abs(1-n.total/t)>.001&&Math.abs(n.total-t)>1)return`Invalid total ${n.total} - expected ${t} in row ${JSON.stringify(e)}`;const r=Math.abs(n.price*n.quantity);return n.quantity!==0&&Math.abs(1-r/n.subtotal)>.002&&Math.abs(r-n.subtotal)>1?`Invalid subtotal ${r} - expected ${n.subtotal} in row ${JSON.stringify(e)}`:""}function W(n){const e=n.split(`
`);for(;!e[0].startsWith("ID");)e.shift();const t=e[0].split(",");e.shift();const r=[];for(let s of e){if(s=s.trim(),!s)continue;const i=s.split(",");if(i.length!==t.length)throw new Error(`Invalid row: ${s}`);const c=new Map;c.set("raw",s);for(let a=0;a<t.length;a++){let o=i[a];o.startsWith('"')&&o.endsWith('"')&&(o=o.slice(1,-1)),c.set(t[a],o)}r.push(Object.fromEntries(c))}return r}function B(n){const e=W(n),t=[],r=[],s=[];for(const i of e){let c={raw:i.raw,id:i.ID,time:K(i.Timestamp),type:i["Transaction Type"],asset:i.Asset,quantity:m(i["Quantity Transacted"]),price:m(i["Price at Transaction"]),priceCurrency:i["Price Currency"],subtotal:m(i.Subtotal),total:m(i["Total (inclusive of fees and/or spread)"]),fee:m(i["Fees and/or Spread"]),notes:i.Notes,quantitySold:0,gainOrLoss:0};c.asset==="USDC"&&c.priceCurrency==="USD"&&(c=J(c));const a=H(c,i);if(a){r.push(a);continue}const o=M(c,i);o&&s.push(o),t.push(c)}return t.sort((i,c)=>i.time.getTime()-c.time.getTime()),{transactions:t,errors:r,warnings:s}}function J(n){const e=n.notes.match(/(Bought|Sold) ([0-9.]+) USDC for ([0-9.]+) ([A-Z]+) on ([A-Z]+-[A-Z]+) at ([0-9.]+) ([A-Z]+\/USDC)/);if(!e)return n;const t=m(e[2]),r=m(e[6]),s=e[4],i=m(e[3]),c=n.fee*r;return{...n,quantity:t,price:r,priceCurrency:s,fee:c,subtotal:i-c,total:i}}function $(n){return["Quantity Transacted","Price at Transaction","Subtotal","Total (inclusive of fees and/or spread)","Fees and/or Spread"].includes(n)}function m(n){return n?Math.abs(parseFloat(n.replace(/\$/,""))):0}function K(n){if(!n)throw new Error("Invalid timestamp: "+n);const e=n.split(" ");if(e.length!==3)throw new Error(`Invalid timestamp: ${n}`);if(e[2]!=="UTC")throw new Error(`Invalid timezone: ${e[2]}`);const t=e[0].split("-"),r=e[1].split(":");return new Date(Date.UTC(parseInt(t[0]),parseInt(t[1])-1,parseInt(t[2]),parseInt(r[0]),parseInt(r[1]),parseInt(r[2])))}class Z{render(e){const t=document.createElement("div");if(t.classList.add("sectionErrors"),e.file.errors.length){const r=document.createElement("h2");r.innerText="Errors",t.appendChild(r)}for(const r of e.file.errors){const s=document.createElement("div");s.innerText=r,s.classList.add("error"),t.appendChild(s)}if(e.file.warnings.length){const r=document.createElement("h2");r.innerText="Warnings",t.appendChild(r)}for(const r of e.file.warnings){const s=document.createElement("div");s.innerText=r,s.classList.add("warning"),t.appendChild(s)}return t}}class Q{constructor(e){this.title=e}render(e){const t=document.createElement("div"),r=document.createElement("h2");r.innerText="Realized gain or loss for "+this.title,t.appendChild(r);const s=e.executedTransactions,i=s.map(a=>a.time.getUTCFullYear()),c=Array.from(new Set(i)).sort((a,o)=>a-o);for(const a of c){const o=s.filter(u=>u.time.getUTCFullYear()===a&&u.gainOrLoss!==0);if(o.length===0)continue;const d=new Set(o.map(u=>u.priceCurrency));for(const u of d){const l=o.filter(T=>T.priceCurrency===u);l.length!==0&&t.appendChild(this.renderYearSection(a,l))}}return t}renderYearSection(e,t){const r=document.createElement("div"),s=document.createElement("h3");s.innerText="Calendar year "+e+" in "+t[0].priceCurrency,r.appendChild(s);const i=document.createElement("table");i.classList.add("yearSecurityTable"),r.appendChild(i);const c=document.createElement("thead");i.appendChild(c);const a=document.createElement("tr");c.appendChild(a);const o=["Security","Gain "+t[0].priceCurrency];for(const h of o){const p=document.createElement("th");p.innerText=h,$(h)&&p.classList.add("numeric"),a.appendChild(p)}const d=new Map;for(const h of t){const p=h.asset,y=d.get(p)||0;d.set(p,y+h.gainOrLoss)}for(const[h,p]of d){const y=document.createElement("tr");i.appendChild(y);const F=document.createElement("td"),b=document.createElement("a");b.innerText=h,b.href="#"+h,F.appendChild(b),y.appendChild(F);const x=document.createElement("td");x.innerText=p.toFixed(2),x.classList.add(p>0?"positive":"negative"),y.appendChild(x)}const u=Array.from(i.rows).slice(1);u.sort((h,p)=>h.cells[0].innerText.localeCompare(p.cells[0].innerText));for(const h of u)i.appendChild(h);const l=document.createElement("tr");l.classList.add("totalRow"),i.appendChild(l);const T=document.createElement("td");T.innerText="Total",l.appendChild(T);const v=document.createElement("td"),D=t.reduce((h,p)=>h+p.gainOrLoss,0);return v.innerText=D.toFixed(2),v.classList.add(D>0?"positive":"negative"),l.appendChild(v),r}}async function j(n,e,t){if(n==="USD")return{targetCurrency:"USD",convertFromUSD:a=>a,getExchangeRateFromUSD:()=>1};const r=`exchangeRates-${n}`,s=JSON.parse(localStorage.getItem(r)||"{}"),c=Array.from(new Set(e.map(a=>a.time.toISOString().split("T")[0]))).filter(a=>!(a in s));try{for(const a of c){const o=`https://api.coinbase.com/v2/prices/${n}-USD/spot?date=${a}`,d=await fetch(o);if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);const u=await d.json(),l=parseFloat(u.data.amount);s[a]=l,t(`Fetched exchange rate for ${a}: ${l}`),localStorage.setItem(r,JSON.stringify(s))}}catch(a){throw console.error("Error fetching exchange rates:",a),new Error("Failed to fetch exchange rates")}return{targetCurrency:n,convertFromUSD:(a,o)=>{const d=o.toISOString().split("T")[0],u=s[d];if(u===void 0)throw new Error(`Exchange rate for ${d} not found`);return parseFloat((a/u).toFixed(2))},getExchangeRateFromUSD:a=>1/s[a]}}function f(n){return P.get(n)||n}async function z(n,e,t){const r=n.transactions.sort((c,a)=>c.time.getTime()-a.time.getTime()),s=await j(e,r,t),i=k(r);return n.warnings.push(...i),{file:n,executedTransactions:r,exchange:s}}function k(n){const e=n.filter(r=>w.includes(r.type)),t=[];for(const r of e){const s=n.filter(a=>L.includes(a.type)&&a.asset===r.asset&&a.time<r.time&&Math.abs(a.quantitySold-a.quantity)>Y);let i=r.quantity,c=0;for(const a of s){const o=Math.min(a.quantity-a.quantitySold,i);if(a.quantitySold+=o,c+=a.total/a.quantity*o,i-=o,i===0)break}r.price*i>.05&&t.push(`Unable to find the buy for ${i} ${r.asset} in ${r.raw} - gains can be overstated by ${r.price*i}`),r.gainOrLoss=r.total-c}return t}function V(n){let e=0;for(const t of n)G.includes(t.type)?e+=t.quantity:S.includes(t.type)&&(e-=t.quantity);return e}class X{constructor(e,t,r){g(this,"firstTransaction");g(this,"priceCurrency");g(this,"headers");g(this,"needsCurrencyConversion",!1);if(this.groupKey=e,this.transactions=t,this.exchange=r,t.length===0)throw new Error("No transactions provided for "+e);this.firstTransaction=t[0],this.priceCurrency=this.firstTransaction.priceCurrency,this.needsCurrencyConversion=this.firstTransaction.priceCurrency!==this.exchange.targetCurrency&&this.firstTransaction.asset!==this.exchange.targetCurrency,this.headers=["Time","Type",`Quantity ${this.firstTransaction.asset}`,`Price ${f(this.priceCurrency)}`],this.needsCurrencyConversion&&this.headers.push(`Price ${f(this.exchange.targetCurrency)}`),this.headers.push(`Fee ${f(this.priceCurrency)}`),this.needsCurrencyConversion&&this.headers.push(`Fee ${f(this.exchange.targetCurrency)}`),this.headers.push(`Total ${f(this.priceCurrency)}`),this.needsCurrencyConversion&&this.headers.push(`Total ${f(this.exchange.targetCurrency)}`),this.headers.push(`Gain ${f(this.priceCurrency)}`),this.needsCurrencyConversion&&this.headers.push(`Gain ${f(this.exchange.targetCurrency)}`)}renderGroup(){const e=document.createElement("div");if(e.classList.add("transactionGroup"),this.transactions.length===0)return e;this.transactions.sort((r,s)=>r.time.getTime()-s.time.getTime()),e.dataset.sortKey=`${C.includes(this.firstTransaction.asset)||E.includes(this.firstTransaction.asset)?0:1}-${this.firstTransaction.asset}`,this.renderGroupHeader(e);const t=this.createTableStructure(e);return this.renderTableHeader(t),this.renderTableBody(t),this.renderTableFooter(t),this.renderGainLossByYear(e),e}renderGroupHeader(e){const t=document.createElement("h2");t.innerText=this.groupKey,t.id=this.firstTransaction.asset,e.appendChild(t)}createTableStructure(e){const t=document.createElement("table"),r=document.createElement("div");return r.classList.add("tableScroller"),r.appendChild(t),e.appendChild(r),t}renderTableHeader(e){const t=document.createElement("thead"),r=document.createElement("tr");t.appendChild(r),e.appendChild(t);for(const s of this.headers){const i=document.createElement("th");i.innerText=s,$(s)&&i.classList.add("numeric"),r.appendChild(i)}}renderTableBody(e){const t=C.includes(this.firstTransaction.asset)||E.includes(this.firstTransaction.asset)?1:-1;for(const r of this.transactions){const s=document.createElement("tr");s.title=r.raw,e.appendChild(s);const i=[r.time.toISOString().split("T")[0],r.type,r.quantity,r.price];this.needsCurrencyConversion&&i.push(this.exchange.convertFromUSD(r.price,r.time)),i.push(r.fee),this.needsCurrencyConversion&&i.push(this.exchange.convertFromUSD(r.fee,r.time));const c=r.total*(S.includes(r.type)?-1:1)*t;i.push(c),this.needsCurrencyConversion&&i.push(this.exchange.convertFromUSD(c,r.time)),i.push(r.gainOrLoss),this.needsCurrencyConversion&&i.push(this.exchange.convertFromUSD(r.gainOrLoss,r.time));for(let a=0;a<i.length;a++){const o=i[a],d=document.createElement("td");o===0?d.innerText="":typeof o=="number"?(d.innerText=o.toFixed(this.headers[a].startsWith("Price")&&Math.abs(o)<1e4?4:2),d.classList.add("numeric"),(this.headers[a].startsWith("Total")||this.headers[a].startsWith("Gain"))&&d.classList.add(o>0?"positive":"negative")):d.innerText=String(o),s.appendChild(d)}}}renderTableFooter(e){const t=document.createElement("tr");t.classList.add("totalRow"),e.appendChild(t),t.appendChild(this.createTd("Total")),t.appendChild(document.createElement("td"));const r=V(this.transactions);t.appendChild(this.createNumericTd(r,2,!1)),t.appendChild(document.createElement("td")),this.needsCurrencyConversion&&t.appendChild(document.createElement("td"));const s=this.transactions.reduce((o,d)=>o+d.fee,0);if(t.appendChild(this.createNumericTd(s,2,!0)),this.needsCurrencyConversion){const o=this.transactions.reduce((d,u)=>d+this.exchange.convertFromUSD(u.fee,u.time),0);t.appendChild(this.createNumericTd(o,2,!0))}const i=C.includes(this.firstTransaction.asset)||E.includes(this.firstTransaction.asset)?1:-1,c=this.transactions.reduce((o,d)=>o+d.total*(S.includes(d.type)?-1:1)*i,0);if(t.appendChild(this.createNumericTd(c,2,!0)),this.needsCurrencyConversion){const o=this.transactions.reduce((d,u)=>d+this.exchange.convertFromUSD(u.total*(S.includes(u.type)?-1:1),u.time)*i,0);t.appendChild(this.createNumericTd(o,2,!0))}const a=this.transactions.reduce((o,d)=>o+d.gainOrLoss,0);if(t.appendChild(this.createNumericTd(a,2,!0)),this.needsCurrencyConversion){const o=this.transactions.reduce((d,u)=>d+this.exchange.convertFromUSD(u.gainOrLoss,u.time),0);t.appendChild(this.createNumericTd(o,2,!0))}}renderGainLossByYear(e){const t=new Map,r=new Map;for(const o of this.transactions){if(o.gainOrLoss===0)continue;const d=o.time.getUTCFullYear(),u=t.get(d)||0;if(t.set(d,u+o.gainOrLoss),this.needsCurrencyConversion){const l=r.get(d)||0;r.set(d,l+this.exchange.convertFromUSD(o.gainOrLoss,o.time))}}if(t.size===0)return;e.appendChild(document.createElement("br"));const s=document.createElement("table");e.appendChild(s);const i=document.createElement("thead"),c=document.createElement("tr");i.appendChild(c),s.appendChild(i);const a=["Year",`Gain ${f(this.priceCurrency)}`];this.needsCurrencyConversion&&a.push(`Gain ${f(this.exchange.targetCurrency)}`);for(const o of a){const d=document.createElement("th");d.innerText=o,$(o)&&d.classList.add("numeric"),c.appendChild(d)}for(const[o,d]of t){const u=document.createElement("tr");if(s.appendChild(u),u.appendChild(this.createTd(String(o))),u.appendChild(this.createNumericTd(d,2,!0)),this.needsCurrencyConversion){const l=r.get(o)||0;u.appendChild(this.createNumericTd(l,2,!0))}}}createTd(e){const t=document.createElement("td");return t.innerText=e,t}createNumericTd(e,t,r){const s=document.createElement("td");return e&&(s.innerText=e.toFixed(t),s.classList.add("numeric"),r&&s.classList.add(e>0?"positive":"negative")),s}}class _{render(e){const t=document.createElement("div"),r=ee(e.executedTransactions),s=[];for(const[i,c]of r)s.push(new X(i,c,e.exchange).renderGroup());return s.sort((i,c)=>i.dataset.sortKey.localeCompare(c.dataset.sortKey)),t.replaceChildren(...s),t}}function ee(n){const e=new Map;for(const t of n){const r=te(t),s=e.get(r)||[];s.push(t),e.set(r,s)}return e}function te(n){return n.type==="Deposit"||n.type==="Withdrawal"?"Deposit / Withdrawal":n.type==="Reward Income"?n.type:E.includes(n.asset)&&(L.includes(n.type)||w.includes(n.type))?`${n.asset} Trading`:C.includes(n.asset)?n.type:n.asset}const N=document.getElementById("transactionOutput"),ne=document.getElementById("calculateGainLoss"),I=document.getElementById("currencySelect");for(const n of C.concat().sort()){if(n==="USD")continue;const e=document.createElement("option");e.value=n,e.innerText=n,e.selected=n==="EUR",I.appendChild(e)}const U=document.getElementById("transactionInput");U.addEventListener("change",O);function O(){const n=U.files;if(!n)return;const e=n[0];if(!e)return;const t=new FileReader;t.onload=async()=>{try{await re(B(t.result))}catch(r){alert(`Error parsing file: ${r}`)}},t.onerror=r=>{alert(`Error reading file: ${r}`)},t.readAsText(e)}O();async function re(n){const e=await z(n,se(),t=>{N.innerText=t});N.replaceChildren(new Z().render(e),new Q("Years").render(e),new _().render(e))}function se(){return ne.checked&&I.value||"USD"}

</script>
  <style>
html{padding:0;margin:0}body{font-family:Roboto;padding:0 20px;max-width:1000px;margin:0 auto 50px}.error{color:red;padding-bottom:10px}.warning{color:#ff9100;padding-bottom:10px}table{border-collapse:collapse}.yearSecurityTable{width:100%}th,td{padding:5px;border:1px solid #ddd;text-align:left;min-width:50px}th,.totalRow{background-color:#f2f2f2;font-weight:700}.numeric{text-align:right}.positive{color:green;text-align:right}.negative{color:red;text-align:right}

</style>
</head>

<body>
  <h1>📖 coinbuch</h1>
  <p>
    Open-source tool for analysing Coinbase transaction log.
    <a href="https://github.com/kachurovskiy/coinbuch/">Learn more on GitHub</a>
  </p>
  <p>
    <label>
      <input type="checkbox" id="calculateGainLoss" />
      Calculate Gain in another currency
    </label>
    <label for="currencySelect">Currency:</label>
    <select id="currencySelect"></select>
  </p>
  <p>
    Transactions CSV from <a href="https://accounts.coinbase.com/statements">accounts.coinbase.com/statements</a>: <input type="file" id="transactionInput" accept=".csv"/>
  </p>
  <div id="transactionOutput"></div>
  
</body>

</html>
