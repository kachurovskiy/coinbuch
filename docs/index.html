<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>coinbuch</title>
  <link rel="icon" href="data:,">
  <script type="module" crossorigin>
var Z=Object.defineProperty;var Q=(r,e,t)=>e in r?Z(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var $=(r,e,t)=>(Q(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();const R=["Advanced Trade Buy","Receive"],v=["Advanced Trade Sell","Send"],q=v.concat(["Withdrawal"]),j=R.concat(["Deposit","Reward Income","Subscription Rebate","Subscription Rebates (24 Hours)"]),z=["Advanced Trade Buy","Advanced Trade Sell","Deposit","Receive","Reward Income","Send","Subscription Rebate","Subscription Rebates (24 Hours)","Withdrawal"],N=["AUD","CAD","CHF","CNY","EUR","GBP","HKD","JPY","KRW","NZD","SGD","USD"],V=new Map([["AUD","A$"],["CAD","C$"],["CHF","CHF"],["CNY","¥"],["EUR","€"],["GBP","£"],["HKD","$"],["JPY","¥"],["KRW","₩"],["NZD","NZ$"],["SGD","SGD"],["USD","$"]]),U=["USDC","USDT"],X=1e-7;class u{constructor(e,t){$(this,"amount");$(this,"currency");this.amount=e,this.currency=t}toString(){return this.toFixed(2)}plus(e){if(this.currency!==e.currency)throw new Error(`Cannot add ${this.currency} and ${e.currency}`);return new u(this.amount+e.amount,this.currency)}minus(e){if(this.currency!==e.currency)throw new Error(`Cannot subtract ${this.currency} and ${e.currency}`);return new u(this.amount-e.amount,this.currency)}multiply(e){return new u(this.amount*e,this.currency)}convert(e,t,n){const s=n||t.targetCurrency;if(this.currency===s)return this;const i=e.toISOString().split("T")[0],c=t.getExchangeRateFromUSD(i);if(c===void 0)throw new Error(`Exchange rate for ${s} at ${i} not found`);if(this.currency==="USD")return new u(this.amount*c,s);if(s==="USD"&&this.currency===t.targetCurrency)return new u(this.amount/c,s);throw new Error(`Cannot convert ${this.currency} to ${s}`)}toFixed(e){return this.amount?this.amount.toFixed(e)+T(this.currency):""}}async function _(r,e,t){if(r==="USD")return{targetCurrency:"USD",convertFromUSD:o=>o,getExchangeRateFromUSD:()=>1};const n=`exchangeRates-${r}`,s=JSON.parse(localStorage.getItem(n)||"{}"),c=Array.from(new Set(e.map(o=>o.time.toISOString().split("T")[0]))).filter(o=>!(o in s));try{for(const o of c){const a=`https://api.coinbase.com/v2/prices/${r}-USD/spot?date=${o}`,l=await fetch(a);if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const f=await l.json(),w=parseFloat(f.data.amount);s[o]=w,t(`Fetched exchange rate for ${o}: ${w}`),localStorage.setItem(n,JSON.stringify(s))}}catch(o){throw console.error("Error fetching exchange rates:",o),new Error("Failed to fetch exchange rates")}return{targetCurrency:r,convertFromUSD:(o,a)=>{const l=a.toISOString().split("T")[0],f=s[l];if(f===void 0)throw new Error(`Exchange rate for ${l} not found`);return parseFloat((o/f).toFixed(2))},getExchangeRateFromUSD:o=>1/s[o]}}function T(r){return V.get(r)||r}function ee(r,e){for(const t of r)if(t.priceCurrency!==e&&t.asset!==e)return!0;return!1}function te(r,e){return r.time.getFullYear()<2e3||r.time.getFullYear()>2100?`Invalid year ${r.time.getFullYear()} in row ${JSON.stringify(e)}`:z.includes(r.type)?isNaN(r.quantity)?`Invalid quantity ${r.quantity} in row ${JSON.stringify(e)}`:isNaN(r.price.amount)||r.price.amount<0?`Invalid price ${r.price} in row ${JSON.stringify(e)}`:isNaN(r.fee.amount)||r.fee.amount<0?`Invalid fee ${r.fee} in row ${JSON.stringify(e)}`:isNaN(r.subtotal.amount)?`Invalid subtotal ${r.subtotal} in row ${JSON.stringify(e)}`:isNaN(r.total.amount)?`Invalid total ${r.total} in row ${JSON.stringify(e)}`:"":`Invalid transaction type ${r.type} in row ${JSON.stringify(e)}`}function ne(r,e){const t=r.subtotal.plus(r.fee.multiply(v.includes(r.type)?-1:1));if(t.amount>0&&Math.abs(1-r.total.amount/t.amount)>.001&&Math.abs(r.total.amount-t.amount)>1)return`Invalid total ${r.total} - expected ${t} in row ${JSON.stringify(e)}`;const n=Math.abs(r.price.amount*r.quantity);return r.quantity!==0&&Math.abs(1-n/r.subtotal.amount)>.002&&Math.abs(n-r.subtotal.amount)>1?`Invalid subtotal ${n} - expected ${r.subtotal} in row ${JSON.stringify(e)}`:""}function re(r){const e=r.split(`
`);for(;!e[0].startsWith("ID");)e.shift();const t=e[0].split(",");e.shift();const n=[];for(let s of e){if(s=s.trim(),!s)continue;const i=s.split(",");if(i.length!==t.length)throw new Error(`Invalid row: ${s}`);const c=new Map;c.set("raw",s);for(let o=0;o<t.length;o++){let a=i[o];a.startsWith('"')&&a.endsWith('"')&&(a=a.slice(1,-1)),c.set(t[o],a)}n.push(Object.fromEntries(c))}return n}function se(r){const e=re(r),t=[],n=[],s=[];for(const i of e){const c=i["Price Currency"];let o={raw:i.raw,id:i.ID,time:ae(i.Timestamp),type:i["Transaction Type"],asset:i.Asset,quantity:D(i["Quantity Transacted"]),price:new u(D(i["Price at Transaction"]),c),priceCurrency:c,subtotal:new u(D(i.Subtotal),c),total:new u(D(i["Total (inclusive of fees and/or spread)"]),c),fee:new u(D(i["Fees and/or Spread"]),c),notes:i.Notes,quantitySold:0,gainOrLoss:new u(0,c),buyTransactions:[]};o.asset==="USDC"&&c==="USD"&&(o=ie(o));const a=te(o,i);if(a){n.push(a);continue}const l=ne(o,i);l&&s.push(l),t.push(o)}return t.sort((i,c)=>i.time.getTime()-c.time.getTime()),{transactions:t,errors:n,warnings:s}}function ie(r){const e=r.notes.match(/(Bought|Sold) ([0-9.]+) USDC for ([0-9.]+) ([A-Z]+) on ([A-Z]+-[A-Z]+) at ([0-9.]+) ([A-Z]+\/USDC)/);if(!e)return r;const t=D(e[2]),n=e[4],s=D(e[6]),i=new u(D(e[3]),n),c=new u(r.fee.amount*s,n);return{...r,quantity:t,price:new u(s,n),priceCurrency:n,fee:c,subtotal:i.minus(c),total:i,gainOrLoss:new u(0,n)}}function O(r){return["Quantity Transacted","Price at Transaction","Subtotal","Total (inclusive of fees and/or spread)","Fees and/or Spread"].includes(r)}function D(r){return r?Math.abs(parseFloat(r.replace(/\$/,""))):0}function ae(r){if(!r)throw new Error("Invalid timestamp: "+r);const e=r.split(" ");if(e.length!==3)throw new Error(`Invalid timestamp: ${r}`);if(e[2]!=="UTC")throw new Error(`Invalid timezone: ${e[2]}`);const t=e[0].split("-"),n=e[1].split(":");return new Date(Date.UTC(parseInt(t[0]),parseInt(t[1])-1,parseInt(t[2]),parseInt(n[0]),parseInt(n[1]),parseInt(n[2])))}class oe{render(e){const t=document.createElement("div");if(t.classList.add("sectionErrors"),e.file.errors.length){const n=document.createElement("h2");n.innerText="Errors",t.appendChild(n)}for(const n of e.file.errors){const s=document.createElement("div");s.innerText=n,s.classList.add("error"),t.appendChild(s)}if(e.file.warnings.length){const n=document.createElement("h2");n.innerText="Warnings",t.appendChild(n)}for(const n of e.file.warnings){const s=document.createElement("div");s.innerText=n,s.classList.add("warning"),t.appendChild(s)}return t}}class ce{constructor(e,t,n){this.model=e,this.year=t,this.transactions=n}render(){const e=document.createElement("div"),t=document.createElement("h3");t.innerText="Calendar year "+this.year,e.appendChild(t);const n=document.createElement("table");n.classList.add("yearSecurityTable"),e.appendChild(n);const s=document.createElement("thead");n.appendChild(s);const i=document.createElement("tr");s.appendChild(i);const c=["Security","First buy","Last sell","Cost Basis","Cost Basis "+T(this.model.exchange.targetCurrency),"Proceeds","Proceeds "+T(this.model.exchange.targetCurrency),"Gain "+T(this.model.exchange.targetCurrency)];for(const h of c){const m=document.createElement("th");m.innerText=h,O(h)&&m.classList.add("numeric"),i.appendChild(m)}const o=new Map,a=new Map,l=new Map,f=new Map;for(const h of this.transactions){if(!v.includes(h.type))continue;const m=h.asset;let x=o.get(m)||new u(0,h.priceCurrency),E=a.get(m)||new u(0,this.model.exchange.targetCurrency);for(const F of h.buyTransactions){const B=F.transaction.total.multiply(F.quantity/F.transaction.quantity);x=x.plus(B),E=E.plus(B.convert(F.transaction.time,this.model.exchange))}o.set(m,x),a.set(m,E);let I=l.get(m)||new u(0,h.priceCurrency),L=f.get(m)||new u(0,this.model.exchange.targetCurrency);I=I.plus(h.total.convert(h.time,this.model.exchange,I.currency)),L=L.plus(h.total.convert(h.time,this.model.exchange)),l.set(m,I),f.set(m,L)}const w=new Map,p=new Map;for(const h of this.transactions){const m=h.asset;if(R.includes(h.type)){const x=w.get(m);(!x||h.time.getTime()<x.getTime())&&w.set(m,h.time)}else if(v.includes(h.type)){const x=p.get(m);(!x||h.time.getTime()>x.getTime())&&p.set(m,h.time)}}for(const[h]of o){const m=document.createElement("tr");n.appendChild(m);const x=document.createElement("td"),E=document.createElement("a");E.innerText=h,E.href="#"+h,x.appendChild(E),m.appendChild(x);const I=w.get(h),L=document.createElement("td");I&&(L.innerText=I.toISOString().split("T")[0]),m.appendChild(L);const F=p.get(h),B=document.createElement("td");F&&(B.innerText=F.toISOString().split("T")[0]),m.appendChild(B);const J=o.get(h)||new u(0,this.model.exchange.targetCurrency);m.appendChild(M(J));const P=a.get(h)||new u(0,this.model.exchange.targetCurrency);m.appendChild(M(P));const K=l.get(h)||new u(0,this.model.exchange.targetCurrency);m.appendChild(M(K));const A=f.get(h)||new u(0,this.model.exchange.targetCurrency);m.appendChild(M(A));const k=A.minus(P);m.appendChild(M(k,!0))}const y=Array.from(n.rows).slice(1);y.sort((h,m)=>h.cells[0].innerText.localeCompare(m.cells[0].innerText));for(const h of y)n.appendChild(h);const d=document.createElement("tr");d.classList.add("totalRow"),n.appendChild(d);const g=document.createElement("td");g.innerText="Total",d.appendChild(g),d.appendChild(document.createElement("td")),d.appendChild(document.createElement("td")),d.appendChild(document.createElement("td"));const C=Array.from(a.values()).reduce((h,m)=>h.plus(m),new u(0,this.model.exchange.targetCurrency));d.appendChild(M(C)),d.appendChild(document.createElement("td"));const S=Array.from(f.values()).reduce((h,m)=>h.plus(m),new u(0,this.model.exchange.targetCurrency));d.appendChild(M(S));const b=S.minus(C);return d.appendChild(M(b,!0)),e}}function M(r,e=!1){const t=document.createElement("td");return t.innerText=r.toFixed(2),e&&t.classList.add(r.amount>0?"positive":"negative"),t}class le{constructor(e){this.model=e}render(){const e=document.createElement("div"),t=document.createElement("h2");t.innerText="Realized gain or loss for all years",e.appendChild(t);const n=this.model.executedTransactions,s=n.map(c=>c.time.getUTCFullYear()),i=Array.from(new Set(s)).sort((c,o)=>c-o);for(const c of i){const o=n.filter(a=>a.time.getUTCFullYear()===c);e.appendChild(new ce(this.model,c,o).render())}return e}}async function ue(r,e,t,n){const s=e.transactions.sort((o,a)=>o.time.getTime()-a.time.getTime()),i=await _(t,s,n),c=de(s);return e.warnings.push(...c),{name:r,file:e,executedTransactions:s,exchange:i}}function de(r){const e=r.filter(n=>v.includes(n.type)),t=[];for(const n of e){const s=r.filter(a=>R.includes(a.type)&&a.asset===n.asset&&a.time<n.time&&Math.abs(a.quantitySold-a.quantity)>X);let i=n.quantity,c=new u(0,n.priceCurrency),o=new u(0,n.priceCurrency);for(const a of s){const l=Math.min(a.quantity-a.quantitySold,i);if(a.quantitySold+=l,n.buyTransactions.push({quantity:l,transaction:a}),c=c.plus(a.total.multiply(l/a.quantity)),o=o.plus(a.fee.multiply(l/a.quantity)),i-=l,i===0)break}n.price.amount*i>.05&&t.push(`Unable to find the buy for ${i} ${n.asset} in ${n.raw} - gains can be overstated by ${n.price.multiply(i).toFixed(2)}`),n.gainOrLoss=n.total.minus(c)}return t}function he(r){let e=0;for(const t of r)j.includes(t.type)?e+=t.quantity:q.includes(t.type)&&(e-=t.quantity);return e}class pe{constructor(e,t,n){$(this,"firstTransaction");$(this,"priceCurrency");$(this,"headers");$(this,"needsCurrencyConversion",!1);$(this,"exchange");if(this.groupKey=e,this.transactions=t,this.model=n,t.length===0)throw new Error("No transactions provided for "+e);this.firstTransaction=t[0],this.exchange=this.model.exchange,this.priceCurrency=this.firstTransaction.priceCurrency,this.needsCurrencyConversion=ee(t,this.exchange.targetCurrency),this.headers=["Time","Type",`Quantity ${this.firstTransaction.asset}`,`Price ${T(this.priceCurrency)}`],this.needsCurrencyConversion&&this.headers.push(`Price ${T(this.exchange.targetCurrency)}`),this.headers.push(`Fee ${T(this.priceCurrency)}`),this.needsCurrencyConversion&&this.headers.push(`Fee ${T(this.exchange.targetCurrency)}`),this.headers.push(`Total ${T(this.priceCurrency)}`),this.needsCurrencyConversion&&this.headers.push(`Total ${T(this.exchange.targetCurrency)}`),this.headers.push(`Gain ${T(this.priceCurrency)}`),this.needsCurrencyConversion&&this.headers.push(`Gain ${T(this.exchange.targetCurrency)}`)}renderGroup(){const e=document.createElement("div");if(e.classList.add("transactionGroup"),this.transactions.length===0)return e;const t=document.createElement("div");t.className="print-section",t.style.display="none",t.innerHTML=`<h2>Excerpt from the Coinbase transaction analysis report</h2>
    <p>This document was prepared by the <a href="https://github.com/kachurovskiy/coinbuch">coinbuch
    tool</a> on ${new Date().toISOString()} based on Coinbase transaction file ${this.model.name}</p>
    <p>Gains in different currencies don't match because proceeds and cost basis are calculated with exchange
    rate on the day of sell and buy transaction respectively using rates from Coinbase.</p>`,e.appendChild(t),this.transactions.sort((c,o)=>c.time.getTime()-o.time.getTime()),e.dataset.sortKey=`${N.includes(this.firstTransaction.asset)||U.includes(this.firstTransaction.asset)?0:1}-${this.firstTransaction.asset}`,this.renderGroupHeader(e),this.renderGainLossByYear(e);const n=this.createTableStructure(e);this.renderTableHeader(n),this.renderTableBody(n),this.renderTableFooter(n);const s=document.createElement("div");s.className="print-section",s.style.display="none",s.innerHTML=`<h3>Raw Transactions</h3><pre>${this.transactions.map(c=>c.raw).join(`
`)}</pre>`,e.appendChild(s);const i=document.createElement("style");return i.innerHTML=`
      @media print {
        .print-section { display: block !important; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
      }
    `,e.appendChild(i),e}renderGroupHeader(e){const t=document.createElement("h2");t.innerText=this.groupKey,t.id=this.firstTransaction.asset,e.appendChild(t);const n=document.createElement("button");n.innerText="Print",n.className="print-button",n.style.marginLeft="1em",n.onclick=()=>{const s=window.open("","_blank");s&&(s.document.write("<html><head><title>"+this.groupKey+"</title>"),Array.from(document.querySelectorAll('link[rel="stylesheet"],style')).forEach(i=>{s.document.write(i.outerHTML)}),s.document.write("</head><body>"),s.document.write(e.outerHTML),s.document.write("</body></html>"),s.document.close(),s.focus(),setTimeout(()=>{s.print()},300))},t.appendChild(n)}createTableStructure(e){const t=document.createElement("table"),n=document.createElement("div");return n.classList.add("tableScroller"),n.appendChild(t),e.appendChild(n),t}renderTableHeader(e){const t=document.createElement("thead"),n=document.createElement("tr");t.appendChild(n),e.appendChild(t);for(const s of this.headers){const i=document.createElement("th");i.innerText=s,O(s)&&i.classList.add("numeric"),n.appendChild(i)}}renderTableBody(e){const t=N.includes(this.firstTransaction.asset)||U.includes(this.firstTransaction.asset)?1:-1;for(const n of this.transactions){const s=document.createElement("tr");s.title=n.raw,e.appendChild(s);const i=[n.time.toISOString().split("T")[0],n.type,n.quantity,n.price];this.needsCurrencyConversion&&i.push(n.price.convert(n.time,this.exchange)),i.push(n.fee),this.needsCurrencyConversion&&i.push(n.fee.convert(n.time,this.exchange));const c=n.total.multiply(t*(q.includes(n.type)?-1:1));if(i.push(c),this.needsCurrencyConversion&&i.push(c.convert(n.time,this.exchange)),i.push(n.gainOrLoss),this.needsCurrencyConversion)if(v.includes(n.type)){let o=new u(0,this.exchange.targetCurrency);for(const a of n.buyTransactions){const l=a.transaction.total.multiply(a.quantity/a.transaction.quantity);o=o.plus(l.convert(a.transaction.time,this.model.exchange))}i.push(n.total.convert(n.time,this.exchange).minus(o))}else i.push(new u(0,this.exchange.targetCurrency));for(let o=0;o<i.length;o++){const a=i[o],l=document.createElement("td"),f=this.headers[o];a===0?l.innerText="":typeof a=="number"?(l.innerText=a.toFixed(f.startsWith("Price")&&Math.abs(a)<1e4?4:2),l.classList.add("numeric"),(f.startsWith("Total")||f.startsWith("Gain"))&&l.classList.add(a>0?"positive":"negative")):a instanceof u?(l.innerText=a.toFixed(f.startsWith("Price")&&Math.abs(a.amount)<1e4?4:2),l.classList.add("numeric"),(f.startsWith("Total")||f.startsWith("Gain"))&&l.classList.add(a.amount>0?"positive":"negative")):l.innerText=String(a),s.appendChild(l)}}}renderTableFooter(e){const t=document.createElement("tr");t.classList.add("totalRow"),e.appendChild(t),t.appendChild(this.createTd("Total")),t.appendChild(document.createElement("td"));const n=he(this.transactions);t.appendChild(this.createNumericTd(n,2,!1)),t.appendChild(document.createElement("td")),this.needsCurrencyConversion&&t.appendChild(document.createElement("td"));const s=this.transactions.reduce((a,l)=>a.plus(l.fee),new u(0,this.priceCurrency));if(t.appendChild(this.createMoneyTd(s)),this.needsCurrencyConversion){const a=this.transactions.reduce((l,f)=>l.plus(f.fee.convert(f.time,this.exchange)),new u(0,this.exchange.targetCurrency));t.appendChild(this.createMoneyTd(a))}const i=N.includes(this.firstTransaction.asset)||U.includes(this.firstTransaction.asset)?1:-1,c=this.transactions.reduce((a,l)=>a.plus(l.total.multiply((q.includes(l.type)?-1:1)*i)),new u(0,this.priceCurrency));if(t.appendChild(this.createMoneyTd(c)),this.needsCurrencyConversion){const a=this.transactions.reduce((l,f)=>l.plus(f.total.convert(f.time,this.exchange).multiply((q.includes(f.type)?-1:1)*i)),new u(0,this.exchange.targetCurrency));t.appendChild(this.createMoneyTd(a))}const o=this.transactions.reduce((a,l)=>a.plus(l.gainOrLoss.convert(l.time,this.exchange,this.priceCurrency)),new u(0,this.priceCurrency));if(t.appendChild(this.createMoneyTd(o)),this.needsCurrencyConversion){const a=this.transactions.reduce((w,p)=>{let y=new u(0,this.exchange.targetCurrency);for(const d of p.buyTransactions){const g=d.transaction.total.multiply(d.quantity/d.transaction.quantity);y=y.plus(g.convert(d.transaction.time,this.model.exchange))}return w.plus(y)},new u(0,this.exchange.targetCurrency)),f=this.transactions.filter(w=>v.includes(w.type)).reduce((w,p)=>w.plus(p.total.convert(p.time,this.exchange)),new u(0,this.exchange.targetCurrency)).minus(a);t.appendChild(this.createMoneyTd(f))}}renderGainLossByYear(e){const t=new Map,n=new Map,s=new Map,i=new Map;for(const p of this.transactions){if(!v.includes(p.type))continue;const y=p.time.getUTCFullYear();let d=t.get(y)||new u(0,p.priceCurrency),g=n.get(y)||new u(0,this.model.exchange.targetCurrency);for(const b of p.buyTransactions){const h=b.transaction.total.multiply(b.quantity/b.transaction.quantity);d=d.plus(h),g=g.plus(h.convert(b.transaction.time,this.model.exchange))}t.set(y,d),n.set(y,g);let C=s.get(y)||new u(0,p.priceCurrency),S=i.get(y)||new u(0,this.model.exchange.targetCurrency);C=C.plus(p.total.convert(p.time,this.model.exchange,C.currency)),S=S.plus(p.total.convert(p.time,this.model.exchange)),s.set(y,C),i.set(y,S)}const c=new Map,o=new Map;for(const p of this.transactions){const y=p.time.getUTCFullYear();if(R.includes(p.type)){const d=c.get(y);(!d||p.time.getTime()<d.getTime())&&c.set(y,p.time)}else if(v.includes(p.type)){const d=o.get(y);(!d||p.time.getTime()>d.getTime())&&o.set(y,p.time)}}const a=s.size===0,l=document.createElement("table");e.appendChild(l),e.appendChild(document.createElement("br"));const f=document.createElement("thead"),w=document.createElement("tr");if(f.appendChild(w),l.appendChild(f),a){const p=["Year"];p.push(`Total ${T(this.priceCurrency)}`),this.needsCurrencyConversion&&p.push(`Total ${T(this.exchange.targetCurrency)}`);for(const g of p){const C=document.createElement("th");C.innerText=g,O(g)&&C.classList.add("numeric"),w.appendChild(C)}const y=new Map,d=new Map;for(const g of this.transactions){const C=g.time.getUTCFullYear(),S=y.get(C)||new u(0,this.priceCurrency);if(y.set(C,S.plus(g.total)),this.needsCurrencyConversion){const b=d.get(C)||new u(0,this.exchange.targetCurrency);d.set(C,b.plus(g.total.convert(g.time,this.exchange)))}}for(const[g,C]of y){const S=document.createElement("tr");if(l.appendChild(S),S.appendChild(this.createTd(String(g))),S.appendChild(this.createMoneyTd(C)),this.needsCurrencyConversion){const b=d.get(g)||new u(0,this.exchange.targetCurrency);S.appendChild(this.createMoneyTd(b))}}}else{const p=["Year","First Buy","Last Sell"];p.push(`Cost Basis ${T(this.priceCurrency)}`),this.needsCurrencyConversion&&p.push(`Cost Basis ${T(this.exchange.targetCurrency)}`),p.push(`Proceeds ${T(this.priceCurrency)}`),this.needsCurrencyConversion&&p.push(`Proceeds ${T(this.exchange.targetCurrency)}`),p.push(`Gain ${T(this.priceCurrency)}`),this.needsCurrencyConversion&&p.push(`Gain ${T(this.exchange.targetCurrency)}`);for(const y of p){const d=document.createElement("th");d.innerText=y,O(y)&&d.classList.add("numeric"),w.appendChild(d)}for(const[y]of s){const d=document.createElement("tr");l.appendChild(d),d.appendChild(this.createTd(String(y)));const g=c.get(y),C=o.get(y);g?d.appendChild(this.createTd(g.toISOString().split("T")[0])):d.appendChild(this.createTd("")),C?d.appendChild(this.createTd(C.toISOString().split("T")[0])):d.appendChild(this.createTd(""));const S=t.get(y)||new u(0,this.priceCurrency);d.appendChild(this.createMoneyTd(S));const b=n.get(y)||new u(0,this.exchange.targetCurrency);this.needsCurrencyConversion&&d.appendChild(this.createMoneyTd(b));const h=s.get(y)||new u(0,this.priceCurrency);d.appendChild(this.createMoneyTd(h));const m=i.get(y)||new u(0,this.exchange.targetCurrency);this.needsCurrencyConversion&&d.appendChild(this.createMoneyTd(m));const x=h.minus(S);if(d.appendChild(this.createMoneyTd(x)),this.needsCurrencyConversion){const E=m.minus(b);d.appendChild(this.createMoneyTd(E))}}}}createTd(e){const t=document.createElement("td");return t.innerText=e,t}createNumericTd(e,t,n){const s=document.createElement("td");return e&&(s.innerText=e.toFixed(t),s.classList.add("numeric"),n&&s.classList.add(e>0?"positive":"negative")),s}createMoneyTd(e){const t=document.createElement("td");t.innerText=e.toString(),t.classList.add("numeric"),t.classList.add(e.amount>0?"positive":"negative");debugger;return t}}class me{constructor(e){this.model=e}render(){const e=document.createElement("div"),t=ye(this.model.executedTransactions),n=[];for(const[s,i]of t)n.push(new pe(s,i,this.model).renderGroup());return n.sort((s,i)=>s.dataset.sortKey.localeCompare(i.dataset.sortKey)),e.replaceChildren(...n),e}}function ye(r){const e=new Map;for(const t of r){const n=fe(t),s=e.get(n)||[];s.push(t),e.set(n,s)}return e}function fe(r){return r.type==="Deposit"||r.type==="Withdrawal"?"Deposit / Withdrawal":r.type==="Reward Income"?r.type:r.type.startsWith("Subscription Rebate")?"Subscription Rebate":U.includes(r.asset)&&(R.includes(r.type)||v.includes(r.type))?`${r.asset} Trading`:N.includes(r.asset)?r.type:r.asset}const G=document.getElementById("transactionOutput"),ge=document.getElementById("calculateGainLoss"),H=document.getElementById("currencySelect");for(const r of N.concat().sort()){if(r==="USD")continue;const e=document.createElement("option");e.value=r,e.innerText=r,e.selected=r==="EUR",H.appendChild(e)}const Y=document.getElementById("transactionInput");Y.addEventListener("change",W);function W(){const r=Y.files;if(!r)return;const e=r[0];if(!e)return;const t=new FileReader;t.onload=async()=>{try{await Ce(e.name,se(t.result))}catch(n){alert(`Error parsing file: ${n}`)}},t.onerror=n=>{alert(`Error reading file: ${n}`)},t.readAsText(e)}W();async function Ce(r,e){const t=await ue(r,e,Te(),n=>{G.innerText=n});G.replaceChildren(new oe().render(t),new le(t).render(),new me(t).render())}function Te(){return ge.checked&&H.value||"USD"}

</script>
  <style>
html{padding:0;margin:0}body{font-family:Roboto;padding:0 20px;max-width:1000px;margin:0 auto 50px}.error{color:red;padding-bottom:10px}.warning{color:#ff9100;padding-bottom:10px}table{border-collapse:collapse}.yearSecurityTable{width:100%}.transactionGroup{margin:20px 0}th,td{padding:5px;border:1px solid #ddd;text-align:left;min-width:50px}th,.totalRow{background-color:#f2f2f2;font-weight:700}.numeric{text-align:right}.positive{color:green;text-align:right}.negative{color:red;text-align:right}@media print{.print-button{display:none}}

</style>
</head>

<body>
  <h1>📖 coinbuch</h1>
  <p>
    Open-source tool for analysing Coinbase transaction log.
    <a href="https://github.com/kachurovskiy/coinbuch/">Learn more on GitHub</a>
  </p>
  <p>
    <label>
      <input type="checkbox" id="calculateGainLoss" />
      Calculate Gain in another currency
    </label>
    <label for="currencySelect">Currency:</label>
    <select id="currencySelect"></select>
  </p>
  <p>
    Transactions CSV from <a href="https://accounts.coinbase.com/statements">accounts.coinbase.com/statements</a>: <input type="file" id="transactionInput" accept=".csv"/>
  </p>
  <div id="transactionOutput"></div>
  
</body>

</html>
