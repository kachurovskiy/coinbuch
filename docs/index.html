<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>coinbuch</title>
  <link rel="icon" href="data:,">
  <script type="module" crossorigin>
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function r(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=r(i);fetch(i.href,s)}})();const Y=["Advanced Trade Buy","Receive"],O=["Advanced Trade Sell","Send"],D=O.concat(["Withdrawal"]),J=Y.concat(["Deposit","Reward Income","Subscription Rebate","Subscription Rebates (24 Hours)"]),B=["Advanced Trade Buy","Advanced Trade Sell","Deposit","Receive","Reward Income","Send","Subscription Rebate","Subscription Rebates (24 Hours)","Withdrawal"],A=["AUD","CAD","CHF","CNY","EUR","GBP","HKD","JPY","KRW","NZD","SGD","USD"],P=["USDC","USDT"],K=1e-7;function Q(e,t){return e.time.getFullYear()<2e3||e.time.getFullYear()>2100?`Invalid year ${e.time.getFullYear()} in row ${JSON.stringify(t)}`:B.includes(e.type)?isNaN(e.quantity)?`Invalid quantity ${e.quantity} in row ${JSON.stringify(t)}`:isNaN(e.price)||e.price<0?`Invalid price ${e.price} in row ${JSON.stringify(t)}`:isNaN(e.fee)||e.fee<0?`Invalid fee ${e.fee} in row ${JSON.stringify(t)}`:isNaN(e.subtotal)?`Invalid subtotal ${e.subtotal} in row ${JSON.stringify(t)}`:isNaN(e.total)?`Invalid total ${e.total} in row ${JSON.stringify(t)}`:"":`Invalid transaction type ${e.type} in row ${JSON.stringify(t)}`}function Z(e,t){const r=e.subtotal+e.fee*(O.includes(e.type)?-1:1);if(r>0&&Math.abs(1-e.total/r)>.001&&Math.abs(e.total-r)>1)return`Invalid total ${e.total} - expected ${r} in row ${JSON.stringify(t)}`;const n=Math.abs(e.price*e.quantity);return e.quantity!==0&&Math.abs(1-n/e.subtotal)>.002&&Math.abs(n-e.subtotal)>1?`Invalid subtotal ${n} - expected ${e.subtotal} in row ${JSON.stringify(t)}`:""}function z(e){const t=e.split(`
`);for(;!t[0].startsWith("ID");)t.shift();const r=t[0].split(",");t.shift();const n=[];for(let i of t){if(i=i.trim(),!i)continue;const s=i.split(",");if(s.length!==r.length)throw new Error(`Invalid row: ${i}`);const o=new Map;o.set("raw",i);for(let a=0;a<r.length;a++){let l=s[a];l.startsWith('"')&&l.endsWith('"')&&(l=l.slice(1,-1)),o.set(r[a],l)}n.push(Object.fromEntries(o))}return n}function j(e){const t=z(e),r=[],n=[],i=[];for(const s of t){let o={raw:s.raw,id:s.ID,time:X(s.Timestamp),type:s["Transaction Type"],asset:s.Asset,quantity:E(s["Quantity Transacted"]),price:E(s["Price at Transaction"]),priceCurrency:s["Price Currency"],subtotal:E(s.Subtotal),total:E(s["Total (inclusive of fees and/or spread)"]),fee:E(s["Fees and/or Spread"]),notes:s.Notes,quantitySold:0,gainOrLoss:0};o.asset==="USDC"&&o.priceCurrency==="USD"&&(o=V(o));const a=Q(o,s);if(a){n.push(a);continue}const l=Z(o,s);l&&i.push(l),r.push(o)}return r.sort((s,o)=>s.time.getTime()-o.time.getTime()),{transactions:r,errors:n,warnings:i}}function V(e){const t=e.notes.match(/(Bought|Sold) ([0-9.]+) USDC for ([0-9.]+) ([A-Z]+) on ([A-Z]+-[A-Z]+) at ([0-9.]+) ([A-Z]+\/USDC)/);if(!t)return e;const r=E(t[2]),n=E(t[6]),i=t[4],s=E(t[3]),o=e.fee*n;return{...e,quantity:r,price:n,priceCurrency:i,fee:o,subtotal:s-o,total:s}}function U(e){return["Quantity Transacted","Price at Transaction","Subtotal","Total (inclusive of fees and/or spread)","Fees and/or Spread"].includes(e)}function E(e){return e?Math.abs(parseFloat(e.replace(/\$/,""))):0}function X(e){if(!e)throw new Error("Invalid timestamp: "+e);const t=e.split(" ");if(t.length!==3)throw new Error(`Invalid timestamp: ${e}`);if(t[2]!=="UTC")throw new Error(`Invalid timezone: ${t[2]}`);const r=t[0].split("-"),n=t[1].split(":");return new Date(Date.UTC(parseInt(r[0]),parseInt(r[1])-1,parseInt(r[2]),parseInt(n[0]),parseInt(n[1]),parseInt(n[2])))}class _{render(t){const r=document.createElement("div");if(r.classList.add("sectionErrors"),t.file.errors.length){const n=document.createElement("h2");n.innerText="Errors",r.appendChild(n)}for(const n of t.file.errors){const i=document.createElement("div");i.innerText=n,i.classList.add("error"),r.appendChild(i)}if(t.file.warnings.length){const n=document.createElement("h2");n.innerText="Warnings",r.appendChild(n)}for(const n of t.file.warnings){const i=document.createElement("div");i.innerText=n,i.classList.add("warning"),r.appendChild(i)}return r}}class k{constructor(t){this.title=t}render(t){const r=document.createElement("div"),n=document.createElement("h2");n.innerText="Realized gain or loss for "+this.title,r.appendChild(n);const i=t.executedTransactions,s=i.map(a=>a.time.getUTCFullYear()),o=Array.from(new Set(s)).sort((a,l)=>a-l);for(const a of o){const l=i.filter(m=>m.time.getUTCFullYear()===a&&m.gainOrLoss!==0);if(l.length===0)continue;const y=new Set(l.map(m=>m.priceCurrency));for(const m of y){const g=l.filter(f=>f.priceCurrency===m);g.length!==0&&r.appendChild(this.renderYearSection(a,g))}}return r}renderYearSection(t,r){const n=document.createElement("div"),i=document.createElement("h3");i.innerText="Calendar year "+t+" in "+r[0].priceCurrency,n.appendChild(i);const s=document.createElement("table");s.classList.add("yearSecurityTable"),n.appendChild(s);const o=document.createElement("thead");s.appendChild(o);const a=document.createElement("tr");o.appendChild(a);const l=["Security","Gain/Loss "+r[0].priceCurrency];for(const u of l){const p=document.createElement("th");p.innerText=u,U(u)&&p.classList.add("numeric"),a.appendChild(p)}const y=new Map;for(const u of r){const p=u.asset,T=y.get(p)||0;y.set(p,T+u.gainOrLoss)}for(const[u,p]of y){const T=document.createElement("tr");s.appendChild(T);const x=document.createElement("td"),w=document.createElement("a");w.innerText=u,w.href="#"+u,x.appendChild(w),T.appendChild(x);const S=document.createElement("td");S.innerText=p.toFixed(2),S.classList.add(p>0?"positive":"negative"),T.appendChild(S)}const m=Array.from(s.rows).slice(1);m.sort((u,p)=>u.cells[0].innerText.localeCompare(p.cells[0].innerText));for(const u of m)s.appendChild(u);const g=document.createElement("tr");g.classList.add("totalRow"),s.appendChild(g);const f=document.createElement("td");f.innerText="Total",g.appendChild(f);const L=document.createElement("td"),I=r.reduce((u,p)=>u+p.gainOrLoss,0);return L.innerText=I.toFixed(2),L.classList.add(I>0?"positive":"negative"),g.appendChild(L),n}}function ee(e){const t=e.transactions.sort((n,i)=>n.time.getTime()-i.time.getTime()),r=te(t);return e.warnings.push(...r),{file:e,executedTransactions:t}}function te(e){const t=e.filter(n=>O.includes(n.type)),r=[];for(const n of t){const i=e.filter(a=>Y.includes(a.type)&&a.asset===n.asset&&a.time<n.time&&Math.abs(a.quantitySold-a.quantity)>K);let s=n.quantity,o=0;for(const a of i){const l=Math.min(a.quantity-a.quantitySold,s);if(a.quantitySold+=l,o+=a.total/a.quantity*l,s-=l,s===0)break}n.price*s>.05&&r.push(`Unable to find the buy for ${s} ${n.asset} in ${n.raw} - gains can be overstated by ${n.price*s}`),n.gainOrLoss=n.total-o}return r}function ne(e){let t=0;for(const r of e)J.includes(r.type)?t+=r.quantity:D.includes(r.type)&&(t-=r.quantity);return t}class re{render(t){const r=document.createElement("div"),n=se(t.executedTransactions),i=[];for(const s of n)i.push(this.renderGroup(s[1]));return i.sort((s,o)=>s.dataset.sortKey.localeCompare(o.dataset.sortKey)),r.replaceChildren(...i),r}renderGroup(t){const r=document.createElement("div");if(r.classList.add("transactionGroup"),t.length===0)return r;t.sort((c,d)=>c.time.getTime()-d.time.getTime());const n=t[0];r.dataset.sortKey=`${A.includes(n.asset)||P.includes(n.asset)?0:1}-${n.asset}`;const i=document.createElement("h2");i.innerText=G(n),i.id=n.asset,r.appendChild(i);const s=document.createElement("table"),o=document.createElement("div");o.classList.add("tableScroller"),o.appendChild(s),r.appendChild(o);const a=document.createElement("thead"),l=document.createElement("tr");a.appendChild(l),s.appendChild(a);const y=n.priceCurrency,m=["Time","Type","Quantity "+n.asset,"Price "+y,"Fee "+y,"Total "+y,"Gain/Loss "+y];for(const c of m){const d=document.createElement("th");d.innerText=c,U(c)&&d.classList.add("numeric"),l.appendChild(d)}const g=A.includes(n.asset)||P.includes(n.asset)?1:-1;for(const c of t){const d=document.createElement("tr");d.title=c.raw,s.appendChild(d);const b=[c.time.toISOString().split("T")[0],c.type,c.quantity,c.price,c.fee,c.total*(D.includes(c.type)?-1:1)*g,c.gainOrLoss];for(let C=0;C<b.length;C++){const v=b[C],h=document.createElement("td");v===0?h.innerText="":typeof v=="number"?(h.innerText=v.toFixed(m[C].startsWith("Price")?4:2),h.classList.add("numeric"),(m[C].startsWith("Total")||m[C].startsWith("Gain/Loss"))&&h.classList.add(v>0?"positive":"negative")):h.innerText=String(v),d.appendChild(h)}}const f=document.createElement("tr");f.classList.add("totalRow"),s.appendChild(f);const L=document.createElement("td");L.innerText="Total",f.appendChild(L),f.appendChild(document.createElement("td"));const I=document.createElement("td"),u=ne(t);u&&(I.innerText=u.toFixed(2)),f.appendChild(I),f.appendChild(document.createElement("td"));const p=document.createElement("td"),T=t.reduce((c,d)=>c+d.fee,0);T&&(p.innerText=T.toFixed(2),p.classList.add(T>0?"positive":"negative")),f.appendChild(p);const x=document.createElement("td"),w=t.reduce((c,d)=>c+d.total*(D.includes(d.type)?-1:1)*g,0);w&&(x.innerText=w.toFixed(2),x.classList.add(w>0?"positive":"negative")),f.appendChild(x);const S=document.createElement("td"),F=t.reduce((c,d)=>c+d.gainOrLoss,0);F&&(S.innerText=F.toFixed(2),S.classList.add(F>0?"positive":"negative")),f.appendChild(S);const N=new Map;for(const c of t){if(c.gainOrLoss===0)continue;const d=c.time.getUTCFullYear(),b=N.get(d)||0;N.set(d,b+c.gainOrLoss)}if(N.size>0){const c=document.createElement("br");r.appendChild(c);const d=document.createElement("table");r.appendChild(d);const b=document.createElement("thead"),C=document.createElement("tr");b.appendChild(C),d.appendChild(b);const v=["Year","Gain/Loss"];for(const h of v){const $=document.createElement("th");$.innerText=h,U(h)&&$.classList.add("numeric"),C.appendChild($)}for(const[h,$]of N){const R=document.createElement("tr");d.appendChild(R);const W=document.createElement("td");W.innerText=String(h),R.appendChild(W);const q=document.createElement("td");q.innerText=$.toFixed(2),q.classList.add($>0?"positive":"negative"),R.appendChild(q)}}return r}}function se(e){const t=new Map;for(const r of e){const n=G(r),i=t.get(n)||[];i.push(r),t.set(n,i)}return t}function G(e){return e.type==="Deposit"||e.type==="Withdrawal"?"Deposit / Withdrawal":e.type==="Reward Income"?e.type:P.includes(e.asset)&&(Y.includes(e.type)||O.includes(e.type))?`${e.asset} Trading`:A.includes(e.asset)?e.type:e.asset}const M=document.getElementById("transactionInput");M.addEventListener("change",H);function H(){const e=M.files;if(!e)return;const t=e[0];if(!t)return;const r=new FileReader;r.onload=()=>{try{ie(j(r.result))}catch(n){alert(`Error parsing file: ${n}`)}},r.onerror=n=>{alert(`Error reading file: ${n}`)},r.readAsText(t)}H();function ie(e){const t=ee(e);document.getElementById("transactionOutput").replaceChildren(new _().render(t),new k("Years").render(t),new re().render(t))}

</script>
  <style>
html{padding:0;margin:0}body{font-family:Roboto;padding:0 20px;max-width:800px;margin:0 auto 50px}.error{color:red;padding-bottom:10px}.warning{color:#ff9100;padding-bottom:10px}table{border-collapse:collapse}.yearSecurityTable{width:100%}th,td{padding:5px;border:1px solid #ddd;text-align:left;min-width:50px}th,.totalRow{background-color:#f2f2f2;font-weight:700}.numeric{text-align:right}.positive{color:green;text-align:right}.negative{color:red;text-align:right}

</style>
</head>

<body>
  <h1>📖 coinbuch</h1>
  <p>
    Open-source tool for analysing Coinbase transaction log.
    <a href="https://github.com/kachurovskiy/coinbuch/">Learn more on GitHub</a>
  </p>
  <p>
    Transactions CSV from <a href="https://accounts.coinbase.com/statements">accounts.coinbase.com/statements</a>: <input type="file" id="transactionInput" accept=".csv"/>
  </p>
  <div id="transactionOutput"></div>
  
</body>

</html>
